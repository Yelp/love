{% extends theme("layout.html") %}

{% import theme("parts/photobox.html") as photobox %}

{% block title %}Leaderboard{% endblock %}

{% block body %}

{% if username %}
<div class="row">
  <div class="col-xs-6 col-md-4">
    <h1>Legacy for {{ username }}</h1>
  </div>
  <div class="col-xs-12 col-md-8">
    <form class="form-inline leaderboard-filter" role="form">
      <div class="form-group">
        <label class="sr-only" for="username">Username</label>
        <input name="username" class="form-control" id="username" type="text" value="{{ username }}" />
    </div>
    <div class="form-group">
        <button type="button" class="btn btn-default">View Legacy</button>
      </div>
    </form>
  </div>
</div>

<div class="row">
  <div class="col-md-6">
    <label>Filter from </label>
    <input type="date" id="filter-date-start" value="{{ filter_date_start }}">
    <label> to </label>
    <input type="date" id="filter-date-end" value="{{ filter_date_end }}">
    <button type="button" id="filter-date-reset" class="btn btn-default">Reset</button>
  </div>
  <div class="col-md-6">

  </div>
</div>

<div class="row">
    <div class="col-md-6">
        <h2>Recieved love</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Week</th>
                    <th>Love Received</th>
                </tr>
            </thead>
            <tbody>
                {% for week in received_by_week.keys() %}
                    {% set formatted_week = week.strftime('%b %d, %Y') %}
                    {% set received_count = received_by_week[week] %}
                    <tr>
                        <td>Week of <strong>{{ formatted_week }}</strong></td>
                        <td><strong>{{ received_count }}</strong></td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="col-md-6">
        <h2>Sent love</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Week</th>
                    <th>Love Sent</th>
                </tr>
            </thead>
            <tbody>
                {% for week in sent_by_week.keys() %}
                {% set formatted_week = week.strftime('%b %d, %Y') %}
                {% set sent_count = sent_by_week[week] %}
                    <tr>
                        <td>Week of <strong>{{ formatted_week }}</strong></td>
                        <td><strong>{{ sent_count }}</strong></td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
<div class="row">
    <div class="col-xs-6 col-md-4">
      <h1>Legacy</h1>
    </div>
    <div class="col-xs-12 col-md-8">
      <form class="form-inline leaderboard-filter" role="form">
        <div class="form-group">
          <label class="sr-only" for="username">Username</label>
          <input name="username" class="form-control" id="username" type="text"/>
        </div>
        <div class="form-group">
          <button type="button" class="btn btn-default">View Legacy</button>
        </div>
      </form>
    </div>
</div>

<div class="row">
  <div class="col-md-6">
    <label>Filter from </label>
    <input type="date" id="filter-date-start">
    <label> to </label>
    <input type="date" id="filter-date-end">
    <button type="button" id="filter-date-reset" class="btn btn-default">Reset</button>
  </div>
  <div class="col-md-6">

  </div>
</div>
{% endif %}

{% endblock %}

{% block javascript %}
  <script type="text/javascript">
    // 1096614000 is the month Yelp was founded (Oct 2004). 3 extra zeros are added as milliseconds.
    const defaultDateStart = new Date(1096614000000);

    const onDateFilterReset = (e) => {
        $('#filter-date-start').val(defaultDateStart.toString('yyyy-MM-dd'));
        $('#filter-date-end').val(new Date().toString('yyyy-MM-dd'));
    };

    const onViewLegacy = (e) => {
        e.preventDefault();
        const username = $('.leaderboard-filter :input').val();
        if (!$('#filter-date-start').val() || !$('#filter-date-end').val()) {
            onDateFilterReset();
        }
        const unixRangeStart = Math.floor(new Date($('#filter-date-start').val()).getTime() / 1000);
        const unixRangeEnd = Math.floor(new Date($('#filter-date-end').val()).getTime() / 1000);
        
        if (username) {
          const searchParams = new URLSearchParams({ start_date: unixRangeStart, end_date: unixRangeEnd });
          window.location.href = '/legacy/' + username + '?' + searchParams.toString();
        }
    };

    $(document).ready(function() {
        $('.leaderboard-filter button').on('click', onViewLegacy);
        $('form.leaderboard-filter').on('submit', onViewLegacy);
        $('#filter-date-reset').on('click', onDateFilterReset);
        if ($('#filter-date-start').val() == null || $('#filter-date-start').val().length == 0) {
            $('#filter-date-start').val(defaultDateStart.toString('yyyy-MM-dd'));
        }
        if ($('#filter-date-end').val() == null || $('#filter-date-end').val().length == 0) {
            $('#filter-date-end').val(new Date().toString('yyyy-MM-dd'));
        }
    });
  </script>
{% endblock %}
